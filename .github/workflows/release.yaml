name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  prepare-release:
    name: Prepare Release Branch
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi
          echo "‚úÖ Version format is valid: $VERSION"
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Check and prepare release branch
        run: |
          VERSION="${{ inputs.version }}"
          RELEASE_BRANCH="release/v${VERSION}"
          BASE_BRANCH="release_candidate"
          
          echo "üîç Checking if branch '$RELEASE_BRANCH' exists..."
          
          # Fetch all branches
          git fetch origin
          
          # Check if release branch exists remotely
          if git ls-remote --heads origin "$RELEASE_BRANCH" | grep -q "$RELEASE_BRANCH"; then
            echo "‚úÖ Branch '$RELEASE_BRANCH' exists. Rebasing to '$BASE_BRANCH'..."
            
            git checkout "$RELEASE_BRANCH"
            git fetch origin "$BASE_BRANCH"
            git rebase "origin/$BASE_BRANCH"
            git push origin "$RELEASE_BRANCH" --force-with-lease
            
            echo "‚úÖ Successfully rebased '$RELEASE_BRANCH' to '$BASE_BRANCH'"
          else
            echo "‚ÑπÔ∏è Branch '$RELEASE_BRANCH' does not exist. Creating it from '$BASE_BRANCH'..."
            
            git checkout "$BASE_BRANCH"
            git pull origin "$BASE_BRANCH"
            git checkout -b "$RELEASE_BRANCH"
            git push origin "$RELEASE_BRANCH"
            
            echo "‚úÖ Successfully created branch '$RELEASE_BRANCH' from '$BASE_BRANCH'"
          fi
          
          echo "üéâ Release branch '$RELEASE_BRANCH' is ready!"
